<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Todo List with Todoist Sync</title>
<style>
* { box-sizing: border-box; }
body { background-image: linear-gradient(45deg, #eaf, #fea); font-family: Arial, sans-serif; }
.holder { display: flex; position: absolute; top: 0; left: 0; width: 100%; height: 100%; align-items: center; justify-content: center; }
.container { display: flex; flex-direction: column; align-items: center; font-size: 14px; background-color: #eff; border-radius: 15px; padding: 20px; width: 700px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
.clock { font-size: 24px; margin-bottom: 20px; }
.toggle-view button { padding: 10px 20px; font-size: 16px; background-color: #0f9; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
.toggle-view button:focus { outline: none; }
.todo-list, .calendar { display: none; }
.todo-list { width: 600px; background-color: #fef; border-radius: 5px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.task { display: flex; align-items: center; margin-bottom: 20px; padding: 10px; background-color: #ffe; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.task .title { flex-grow: 1; margin-right: 10px; border: none; background-color: transparent; font-size: 16px; }
.task .progress { flex-grow: 1; margin-left: 10px; }
.delete-btn, #newTaskBtn, #clearBtn { border-radius: 5px; padding: 5px 10px; font-size: 14px; cursor: pointer; margin-left: 10px; margin-bottom: 10px;}
.delete-btn { background-color: #ff5151; color: #fff; border: none; }
#newTaskBtn { background-color: #51ff51; color: #000; border: none; }
#clearBtn { background-color: #cacfcf; color: #000; border: none; }
.calendar { width: 300px; font-size: 14px; background-color: #fff; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 20px; }
.calendar-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
.calendar-header button { background-color: transparent; border: none; cursor: pointer; }
.calendar-header .month { font-size: 18px; font-weight: bold; }
.calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
.calendar-day { text-align: center; padding: 5px; background-color: #f2f2f2; }
.current-day { background-color: #ff9a9e; color: #fff; }
.previous-month-day { color: red; }
.palindrome { background-color: #9a9eff; color: #fff; }
</style>
</head>
<body>
<div class="holder">
  <div class="container">
    <div class="clock"></div>
    <div class="toggle-view">
      <button id="toggleViewBtn">Switch To Todo List</button>
    </div>
    <div class="todo-list">
      <h2>Todo List</h2>
      <button id="newTaskBtn">+ New Task</button>
      <button id="clearBtn">Clear All</button>
      <button id="backupBtn">Download Backup</button>
      <div>
        <label>Todoist Token: <input type="password" id="todoistTokenInput" placeholder="Paste token here" style="width: 300px;"></label>
        <button id="saveTokenBtn">Save Token</button>
      </div>
      <div id="tasks"></div>
    </div>
    <div class="calendar">
      <div class="calendar-header">
        <button id="prevMonthBtn">&lt;</button>
        <div class="month" id="monthName"></div>
        <button id="nextMonthBtn">&gt;</button>
      </div>
      <div class="calendar-body">
        <div class="calendar-day">Sun</div>
        <div class="calendar-day">Mon</div>
        <div class="calendar-day">Tue</div>
        <div class="calendar-day">Wed</div>
        <div class="calendar-day">Thu</div>
        <div class="calendar-day">Fri</div>
        <div class="calendar-day">Sat</div>
      </div>
    </div>
  </div>
</div>

<script>
let tasksContainer = document.getElementById("tasks");
let newTaskBtn = document.getElementById("newTaskBtn");
let clearBtn = document.getElementById("clearBtn");
let toggleViewBtn = document.getElementById("toggleViewBtn");
let backupBtn = document.getElementById("backupBtn");
let todoistTokenInput = document.getElementById("todoistTokenInput");
let saveTokenBtn = document.getElementById("saveTokenBtn");

let todoistToken = localStorage.getItem("todoistToken") || "";
todoistTokenInput.value = todoistToken;

let taskList = []; // Each task: {title, progress, todoistId?}

function updateClock() {
  let now = new Date();
  let hours = now.getHours();
  let minutes = now.getMinutes();
  let seconds = now.getSeconds();
  let ampm = hours >= 12 ? "PM":"AM";
  hours = hours%12||12;
  clock.textContent = hours+":"+("0"+minutes).slice(-2)+":"+("0"+seconds).slice(-2)+" "+ampm;
}
setInterval(updateClock,1000);

function saveLocalTasks() {
  localStorage.setItem("tasks",JSON.stringify(taskList));
  localStorage.setItem("tasks_backup_"+Date.now(),JSON.stringify(taskList));
}

function createTaskElement(task) {
  let div = document.createElement("div");
  div.className="task";
  div.innerHTML=`
    <input type="text" class="title" placeholder="Enter task title" value="${task.title}">
    <input type="range" class="progress" min="0" max="100" value="${task.progress}">
    <span class="progress-value">${task.progress}%</span>
    <button class="delete-btn">Delete</button>
  `;
  let titleInput = div.querySelector(".title");
  let progressInput = div.querySelector(".progress");
  let progressValue = div.querySelector(".progress-value");
  let deleteBtn = div.querySelector(".delete-btn");

  titleInput.addEventListener("input", ()=>{ task.title=titleInput.value; saveLocalTasks(); if(task.todoistId) updateTodoistTask(task); });
  progressInput.addEventListener("input", ()=>{ task.progress=progressInput.value; progressValue.textContent=task.progress+"%"; saveLocalTasks(); });
  deleteBtn.addEventListener("click", ()=>{ tasksContainer.removeChild(div); removeTask(task); });

  tasksContainer.appendChild(div);
}

function removeTask(task){
  taskList = taskList.filter(t=>t!==task);
  saveLocalTasks();
  if(task.todoistId) deleteTodoistTask(task.todoistId);
}

function loadLocalTasks(){
  let stored = JSON.parse(localStorage.getItem("tasks")||"[]");
  taskList = stored;
  tasksContainer.innerHTML="";
  taskList.forEach(t=>createTaskElement(t));
}

function backupTasks(){
  let data = JSON.stringify(taskList,null,2);
  let blob = new Blob([data],{type:"application/json"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href=url;
  a.download="tasks_backup_"+Date.now()+".json";
  a.click();
  URL.revokeObjectURL(url);
}

saveTokenBtn.addEventListener("click",()=>{
  todoistToken=todoistTokenInput.value.trim();
  localStorage.setItem("todoistToken",todoistToken);
  if(todoistToken) fetchTodoistTasks();
});

backupBtn.addEventListener("click",backupTasks);

newTaskBtn.addEventListener("click",()=>{
  let newTask={title:"", progress:0};
  taskList.push(newTask);
  createTaskElement(newTask);
  saveLocalTasks();
});

clearBtn.addEventListener("click",()=>{
  taskList=[];
  tasksContainer.innerHTML="";
  saveLocalTasks();
});

toggleViewBtn.addEventListener("click",()=>{
  document.querySelector(".todo-list").style.display = document.querySelector(".todo-list").style.display==="none"?"block":"none";
  document.querySelector(".calendar").style.display = document.querySelector(".calendar").style.display==="block"?"none":"block";
  toggleViewBtn.textContent=document.querySelector(".todo-list").style.display==="block"?"Switch To Calendar":"Switch To Todo List";
});

// --- Todoist API ---
async function fetchTodoistTasks(){
  if(!todoistToken) return;
  try{
    let res = await fetch("https://api.todoist.com/rest/v2/tasks",{headers:{Authorization:"Bearer "+todoistToken}});
    let data = await res.json();
    mergeTodoistTasks(data);
  }catch(e){ console.error("Todoist fetch error:",e);}
}

function mergeTodoistTasks(remoteTasks){
  remoteTasks.forEach(rt=>{
    if(!taskList.some(t=>t.todoistId===rt.id)){
      let task={title:rt.content, progress:0, todoistId:rt.id};
      taskList.push(task);
      createTaskElement(task);
    }
  });
  saveLocalTasks();
}

async function updateTodoistTask(task){
  if(!todoistToken || !task.todoistId) return;
  try{
    await fetch("https://api.todoist.com/rest/v2/tasks/"+task.todoistId,{
      method:"POST",
      headers:{Authorization:"Bearer "+todoistToken,"Content-Type":"application/json"},
      body:JSON.stringify({content:task.title})
    });
  }catch(e){console.error("Todoist update error:",e);}
}

async function deleteTodoistTask(id){
  if(!todoistToken) return;
  try{
    await fetch("https://api.todoist.com/rest/v2/tasks/"+id,{method:"DELETE",headers:{Authorization:"Bearer "+todoistToken}});
  }catch(e){console.error("Todoist delete error:",e);}
}

// Auto-load
loadLocalTasks();
if(todoistToken) fetchTodoistTasks();

// Optional: periodic sync every 60s
setInterval(fetchTodoistTasks,60000);
</script>
</body>
</html>